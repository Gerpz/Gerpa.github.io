<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ì§„ ê³µìœ  ì§€ë„</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 5px; }
        .map-container { display: flex; margin-top: 20px; }
        #map { height: 500px; width: 60%; }
        .upload-container { width: 35%; margin-left: 20px; }
        input, button { display: block; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ ì‚¬ì§„ ê³µìœ  ì§€ë„</h1>
        <p>ìƒë¬¼ ì±„ì§‘ ë° ìƒíƒœ ê´€ì°°ì„ ìœ„í•œ í”Œë«í¼ì…ë‹ˆë‹¤.</p>
        <button onclick="signIn()">ğŸ”‘ Google ë¡œê·¸ì¸</button>
        <button onclick="signOut()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div class="map-container">
        <div id="map"></div>
        <div class="upload-container">
            <h2>ì‚¬ì§„ ì—…ë¡œë“œ</h2>
            <input type="file" id="photoUpload" accept="image/*" capture="environment">
            <button onclick="autoUpload()">ğŸ“¸ ì‚¬ì§„ ì´¬ì˜ ë° ì—…ë¡œë“œ</button>
        </div>
    </div>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyC3nM-w8WysgDcxWwYrf4fb5zFyh-pYRj4",
            authDomain: "biomapdb.firebaseapp.com",
            databaseURL: "https://biomapdb-default-rtdb.firebaseio.com",
            projectId: "biomapdb",
            storageBucket: "biomapdb.firebasestorage.app",
            messagingSenderId: "742608709750",
            appId: "1:742608709750:web:acdb7dd4802d2c96811757",
            measurementId: "G-0NVT6WD4GM"
        };

        // Firebase ì´ˆê¸°í™”
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        var currentUser = null;

        // ë¡œê·¸ì¸ ê¸°ëŠ¥ (Cross-Origin ë¬¸ì œ í•´ê²°)
        function signIn() {
            var provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    currentUser = result.user;
                    console.log("ë¡œê·¸ì¸ ì™„ë£Œ:", currentUser.email);
                    alert(`í™˜ì˜í•©ë‹ˆë‹¤, ${currentUser.displayName}!`);
                })
                .catch((error) => {
                    console.error("ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
                });
        }

        // ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥
        function signOut() {
            auth.signOut().then(() => {
                currentUser = null;
                alert("ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.");
            }).catch((error) => {
                console.error("ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:", error);
            });
        }

        var map = L.map('map').setView([37.5665, 126.9780], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        function autoUpload() {
            if (!currentUser) {
                alert("ë¡œê·¸ì¸ í›„ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”!");
                return;
            }

            var photoInput = document.getElementById("photoUpload");
            photoInput.click(); // ìë™ìœ¼ë¡œ íŒŒì¼ ì„ íƒ ì°½ì„ ì—´ê¸°

            photoInput.onchange = function () {
                var file = photoInput.files[0];
                if (!file) {
                    alert("ì‚¬ì§„ì„ ì´¬ì˜í•˜ì„¸ìš”!");
                    return;
                }

                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;

                    var reader = new FileReader();
                    reader.onload = function (e) {
                        var marker = L.marker([lat, lng]).addTo(map);
                        marker.bindPopup(`<img src="${e.target.result}" width="200px">`).openPopup();

                        var newPostRef = db.ref("photos").push();
                        newPostRef.set({
                            userId: currentUser.uid,
                            latitude: lat,
                            longitude: lng,
                            imageData: e.target.result,
                            id: newPostRef.key
                        });
                    };
                    reader.readAsDataURL(file);
                }, function(error) {
                    alert("ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                });
            };
        }

        function loadMarkers() {
            db.ref("photos").on("value", snapshot => {
                snapshot.forEach(childSnapshot => {
                    var data = childSnapshot.val();
                    var marker = L.marker([data.latitude, data.longitude]).addTo(map);
                    marker.bindPopup(`<img src="${data.imageData}" width="200px">`).openPopup();
                });
            });
        }

        // Firebase ì¸ì¦ ìƒíƒœ í™•ì¸
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                console.log("í˜„ì¬ ë¡œê·¸ì¸:", user.email);
            } else {
                currentUser = null;
                console.log("ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ");
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë§ˆì»¤ ë¶ˆëŸ¬ì˜¤ê¸°
        loadMarkers();
    </script>
</body>
</html>
